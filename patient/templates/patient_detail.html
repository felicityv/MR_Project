{% extends "base.html" %}
{% load static %}

{% block title %}Карточка пациента{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-md-3 text-center">
      {% if patient.foto %}
        <img src="{{ patient.foto.url }}" class="img-thumbnail rounded mb-3" alt="Фото" style="max-height:250px;">
      {% else %}
        <div class="bg-secondary text-white rounded p-5 mb-3">Нет фото</div>
      {% endif %}
      <h4>{{ patient.surname }} {{ patient.name }}</h4>
      <p class="text-muted">{{ patient.age_display }}</p>
    </div>

    <div class="col-md-9">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white"><h5 class="mb-0">Основные сведения</h5></div>
        <div class="card-body">
          <div class="row">
            <div class="col-sm-4"><strong>Пол:</strong> {{ patient.get_gender_display }}</div>
            <div class="col-sm-4"><strong>Дата рождения:</strong> {{ patient.data_birth|date:"j E Y" }}</div>
            <div class="col-sm-4"><strong>СУЗ:</strong> {{ patient.suz|default:"—" }}</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Рост:</strong> {{ patient.rost }} см</div>
            <div class="col-sm-4"><strong>Вес:</strong> {{ patient.ves }} кг</div>
            <div class="col-sm-4"><strong>ИМТ:</strong> {{ patient.imt }}</div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-info text-white"><h5 class="mb-0">Клинико-функциональные данные</h5></div>
        <div class="card-body">
          <p><strong>Диагноз по МКБ-10:</strong><br>
            {% if o.mkb %}
              {{ patient.mkb.code }} – {{ patient.mkb.name|truncatechars:40 }}
            {% else %}
              не указан
            {% endif %}
          </p>
          <p><strong>Основной диагноз:</strong><br>{{ patient.diagnoz_osn|default:"не указан" }}</p>
          <p><strong>Сопутствующий диагноз:</strong><br>{{ patient.diagnoz_sop|default:"не указан" }}</p>
          <p><strong>Степень утраты здоровья (СУЗ):</strong> {{ patient.suz|default:"—" }}</p>
          <p><strong>Реабилитационный (абилитационный) потенциал:</strong> {{ patient.rp|default:"—" }}</p>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-secondary text-white"><h5 class="mb-0">Физическое развитие (последний осмотр)</h5></div>
        <div class="card-body">
          {% if last_osmotr %}
            <div class="row">
              <div class="col-sm-6"><strong>Рост:</strong> {{ last_osmotr.rost }} см (ЦК: {{ last_osmotr.rost_centil|default:"—" }}, SDS={{ last_osmotr.rost_SDS|floatformat:2|default:"—"}})</div>
              <div class="col-sm-6"><strong>Вес:</strong> {{ last_osmotr.ves }} кг (ЦК: {{ last_osmotr.ves_centil|default:"—" }}, SDS={{ last_osmotr.ves_SDS|floatformat:2|default:"—"}})</div>
            </div>
            <div class="row mt-2">
              <div class="col-sm-6"><strong>ИМТ:</strong> {{ last_osmotr.imt }} (ЦК: {{ last_osmotr.imt_centil|default:"—" }}, SDS={{ last_osmotr.imt_SDS|floatformat:2|default:"—"}})</div>
              <div class="col-sm-6"><strong>Физическое развитие:</strong> {{ last_osmotr.fizic_razvitie.all|join:", "|default:"—" }}</div>
            </div>
            <p class="mt-2 mb-0"><strong>Нарушения:</strong> {{ last_osmotr.narushenie.all|join:", "|default:"нет" }}</p>
          {% else %}
            <p class="mb-0 text-muted">Осмотры пока не проводились</p>
          {% endif %}
        </div>
      </div>

      <hr class="my-4">
      <h2>История осмотров</h2>
      {% if osmotry %}
        <div class="table-responsive">
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Дата</th><th>Возраст</th><th>Рост (см)</th><th>Рост SDS</th><th>Рост центиль</th>
                <th>Вес (кг)</th><th>Вес SDS</th><th>Вес центиль</th><th>ИМТ</th><th>ИМТ SDS</th><th>ИМТ центиль</th>
                <th>Физическое развитие</th><th>Нарушения</th><th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for o in osmotry %}
                <tr>
                  <td>{{ o.data_osmotra|date:"j.m.Y" }}</td>
                  <td>{{ o.age_on_date_display }}</td>
                  <td>{{ o.rost }}</td><td>{{ o.rost_SDS|floatformat:2 }}</td><td>{{ o.rost_centil }}</td>
                  <td>{{ o.ves }}</td><td>{{ o.ves_SDS|floatformat:2 }}</td><td>{{ o.ves_centil }}</td>
                  <td>{{ o.imt }}</td><td>{{ o.imt_SDS|floatformat:2 }}</td><td>{{ o.imt_centil }}</td>
                  <td>{{ o.fizic_razvitie.all|join:", "|default:"—" }}</td>
                  <td>{{ o.narushenie.all|join:", "|default:"—" }}</td>
                  <td class="text-nowrap">
                    <!-- Редактировать -->
                    <a href="{% url 'patients:osmotr_edit' osmotr_id=o.id %}"
                      class="btn btn-sm btn-outline-primary me-1"
                      title="Редактировать">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <!-- Удалить -->
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#delOsmotr{{ o.id }}">
                      <i class="bi bi-trash"></i>
                    </button>

                    <div class="modal fade" id="delOsmotr{{ o.id }}" tabindex="-1"
                         aria-labelledby="delOsmotrLabel{{ o.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                          <form method="post" action="{% url 'patients:osmotr_delete' osmotr_id=o.id %}">
                            {% csrf_token %}
                            <div class="modal-header">
                              <h6 class="modal-title" id="delOsmotrLabel{{ o.id }}">Удалить осмотр?</h6>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                              <p class="mb-0"><strong>{{ o.data_osmotra|date:"j.m.Y" }}</strong></p>
                              <small class="text-muted">Действие необратимо</small>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Отмена</button>
                              <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted">Осмотры пока не добавлены.</p>
      {% endif %}

      <div class="mt-3">
        <a href="{% url 'patients:osmotr_add' patient_id=patient.pk %}"
          class="btn btn-primary mb-3">
          <i class="bi bi-plus-circle"></i> Добавить новый осмотр
        </a>
      </div>

      <div class="mt-3">
        <a href="{% url 'patients:patient_list' %}" class="btn btn-outline-secondary">← Назад к списку</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
